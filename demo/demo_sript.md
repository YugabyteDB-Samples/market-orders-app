# Demo Script: Migration to Yugabyte, High-Availability and Live Uprgrades

The demo consists of four steps:

1. Show the existing solution running on PostgreSQL.
2. Migrate from Postrgres to Yugabyte Platform with `yb_migrate`.
3. Tolerate a zone-level outage with Yugabyte Platform.
4. Perform live infrastructure upgrades with Yugabyte Cloud.

## Prerequisite

1. Open two terminal sessions to the Yugabyte Platform machine:
    
    ```shell
    ssh -i platform_secrets/secrets/{cloud_private_certificate} USERNAME@PLATFORM_MACHINE_EXTERNAL_IP
    ```

2. In one terminal window, bootstrap a Postgres docker image:

    ```shell
    docker-compose -f docker-compose-postgres.yml down -v
    docker-compose -f docker-compose-postgres.yml up
    ```

3. In the second terminal window:
    * Clone the `market-orders-app` project:
        ```shell
        mkdir market-order-demo
        cd market-order-demo
        git clone https://github.com/yugabyte/market-orders-app
        ```
    * Make sure that `yb_migrate` is installed and functions. Recreate the `migrations` directory:
        ```shell
        cd market-orders-app/
        rm -r ./migrations
        mkdir migrations
        ```

4. Have 3-node multi-zone Yugabyte Platform and Yugabyte Cloud clusters running.

5. Launch Arctype on your laptop and establish connection to every database:
    * The Postgres on your Platform machine
    * Yugabyte Platform cluster (the YugabyteDB cluster started via Platform) (see `./demo/arctype_platform_connect.png` as an example)
    * Yugabyte Cloud cluster.

6. Add the following SQL queries to Arctype:
    * The `Buyer` query:
        ```sql
        SELECT * FROM Buyer;
        ```
    * The `Trades Count` query:
        ```sql
        select max(id) from Trade;
        ```
    * The `Top Stocks` query:
        ```sql
        SELECT symbol, SUM(bid_price) as total FROM Trade GROUP BY(symbol) ORDER BY total DESC;
        ``` 
    * The `Top Buyers` query:
        ```sql
          SELECT Buyer.id, first_name, last_name, sum(bid_price) as total FROM Buyer
          JOIN Trade ON Trade.buyer_id = Buyer.id
          GROUP BY (Buyer.id) ORDER BY total DESC;
        ```         

7. Drop all the tables and indexes the Yugabyte Platform and Yugabyte Cloud (do NOT touch the Postgres instance):
    ```sql
    DROP TABLE IF EXISTS Trade;
    DROP TABLE IF EXISTS Buyer;
    DROP SEQUENCE IF EXISTS trade_id_seq;
    DROP SEQUENCE IF EXISTS buyer_id_seq;
    ```

8. Recreate schema on Yugabyte Cloud and load Buyers (use `./schema/schema_postgres.sql` and `./schema/data.sql` files). You can use Arctype.


## Step 1: Show the Existing App

1. Show the Postgres instance running in one terminal window of the Platform machine.

2. Execute the `Buyer` and `Top Stock` queries in Arctype.

3. In the second terminal window, start the application:
    ```shell
    cat ./properties/postgres.properties

    java -jar target/market-orders-app.jar connectionProps=./properties/postgres.properties tradeStatsInterval=5000
    ```
4. Show the `Top Stock` queries in Arctype again and the trade stats output generated by the app.    



## Step 2: Migrate to Yugabyte Platform cluster

1. Show the Platform software (universe, three nodes across three zones, etc.) and VMs in Google Cloud Console:

    ```shell
    http://PLATFORM_MACHINE_EXTERNAL_IP
    https://console.cloud.google.com/compute/instances?project=yugabyte-gcp-342503
    ```

2. With Arctype, show that there are no any app relations yet.

3. Stop the application started on step 1.3

4. Export schema and data from Postgres:
    ```shell
    yb_migrate export --source-db-type postgresql --source-db-uri postgresql://postgres:postgres@localhost:5438  --export-dir ./migrations 
    ```
5. Import schema and data to the Platform cluster:
    ```shell
    yb_migrate import schema --target-db-host YBDB_NO_PRIVATE_IP --target-db-port 5433 --target-db-user yugabyte --target-db-password MarketOrders1@ --target-db-name yugabyte --export-dir ./migrations

    yb_migrate import data --target-db-host YBDB_NO_PRIVATE_IP --target-db-port 5433 --target-db-user yugabyte --target-db-password MarketOrders1@ --target-db-name yugabyte --export-dir ./migrations
    ```    

6. Go back to Arctype, and execute the `Buyer` and `Top Stocks` queries (all the relations were created and data loaded)

7. Return to the Platform terminal window and start the app BUT now connect to the Platform cluster:
    ```shell
    cat ./properties/yugabytedb-anywhere.properties

    java -jar target/market-orders-app.jar connectionProps=./properties/yugabytedb-anywhere.properties tradeStatsInterval=5000
    ```

8. Show that the data is being loaded. The migration went well!!!    



## Step 3: Simulate Zone-Level Outage

1. Open Google Cloud Console:

    ```shell
    https://console.cloud.google.com/compute/instances?project=yugabyte-gcp-342503
    ```

2. Stop one of the nodes.

3. Return to the terminal running the app, show that the queries keep running (there might a several-seconds delay while a new leader is elected)

4. Show the Platform UI, nodes, one will become `Unreachable` in ~ 1 minute.

5. Stop the application.

6. Congrats! Yugabyte withstands outages with no impact on your application.



## Step 4: Show Live Infrastructure Upgrades

1. Open your Yugabyte Cloud that has a multi-zone cluster running.

2. Use archtype to show that the Trades table is empty. Execute the `Trades Count` query with Arctype.

3. In the Platform terminal window, start the same application BUT connect to Yugabyte Cluster:
    ```shell
    cat ./properties/yugabytedb-managed.properties

    java -jar target/market-orders-app.jar connectionProps=./properties/yugabytedb-managed.properties tradeStatsInterval=5000
    ```

4. Confirm the app inserts and prints out queries results.

5. Edit the cluster infrastructure, upgrade do instances with more CPUs!

6. Return to the app, show that the app keeps running with no issues!

7. Congrats! You performed a live infrastructure upgared without any maintenance outages!!!

